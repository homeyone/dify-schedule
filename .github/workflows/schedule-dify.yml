name: schedule-multiple-dify-workflows

on:
  schedule:
    - cron: "*/20 * * * *"   # æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 æ‰§è¡Œ
  workflow_dispatch: {}    # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

jobs:
  trigger-all:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger multiple Dify workflows
        env:
          DIFY_BASE_URL: ${{ secrets.DIFY_BASE_URL }}
          DIFY_API_KEYS: ${{ secrets.DIFY_target_API_KEYS }}
        run: |
          set -euo pipefail
          echo "å¼€å§‹æ‰¹é‡è§¦å‘å¤šä¸ª Dify å·¥ä½œæµ..."

          # è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          USER="${{ github.actor }}"

          # å°†å¤šä¸ª API Key ç”¨è‹±æ–‡é€—å·åˆ†éš”å­˜å‚¨åœ¨ Secrets ä¸­
          IFS=',' read -ra KEYS <<< "$DIFY_API_KEYS"

          for key in "${KEYS[@]}"; do
            echo "â¡ï¸ è§¦å‘ Dify å·¥ä½œæµï¼Œä½¿ç”¨ Key: ${key:0:10}..."

            JSON_DATA=$(jq -n \
              --arg user "$USER" \
              --arg time "$TIMESTAMP" \
              '{"inputs": {}, "response_mode": "streaming", "user": $user, "trigger_time": $time}')

            curl --fail --show-error \
              -X POST "${DIFY_BASE_URL}/workflows/run" \
              -H "Authorization: Bearer ${key}" \
              -H "Content-Type: application/json" \
              -d "$JSON_DATA"

            echo "âœ… è§¦å‘å®Œæˆ"
          done

          echo "ğŸ‰ æ‰€æœ‰å·¥ä½œæµè§¦å‘å®Œæˆ"
